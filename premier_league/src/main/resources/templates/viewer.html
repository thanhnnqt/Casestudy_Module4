<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Live Match Viewer</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#38003c', secondary: '#00ff85' } }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- NAVBAR -->
<div th:replace="layout/navbar :: header"></div>

<div class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-xl border-t-4 border-secondary">

    <h2 class="text-3xl font-bold mb-6 text-primary flex items-center gap-3">
        <i data-lucide="broadcast" class="w-7 h-7 text-secondary"></i>
        Trực tiếp trận đấu
    </h2>

    <div class="flex items-end gap-4 mb-8">
        <div class="flex-1">
            <label class="font-semibold">Match ID</label>
            <input id="matchId"
                   class="w-full mt-1 px-4 py-3 border rounded-lg focus:border-primary"
                   value="1"/>
        </div>

        <button id="connect"
                class="px-6 py-3 bg-primary text-white font-bold rounded-lg hover:bg-secondary hover:text-primary transition">
            Kết nối
        </button>
    </div>

    <!-- SCORE -->
    <div class="bg-gray-50 p-6 rounded-xl shadow mb-8 border border-gray-200">
        <h3 class="text-xl font-bold mb-3 text-primary">Tỉ số hiện tại</h3>
        <div id="score" class="text-3xl font-black">-</div>
    </div>

    <!-- EVENTS -->
    <div class="bg-white p-6 rounded-xl shadow mb-8 border border-gray-200">
        <h3 class="text-xl font-bold mb-3 text-primary">Sự kiện</h3>
        <div id="events" class="max-h-80 overflow-y-auto border p-3 rounded-xl bg-gray-50">
            <ul id="eventsList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- RANKINGS -->
    <div class="bg-gray-50 p-6 rounded-xl shadow border border-gray-200">
        <h3 class="text-xl font-bold mb-3 text-primary">Bảng xếp hạng</h3>
        <pre id="ranking" class="text-sm bg-white p-3 rounded-xl"></pre>
    </div>

</div>

<!-- FOOTER -->
<div class="mt-auto" th:replace="layout/footer :: footer"></div>

<script>
    lucide.createIcons();
    let stompClient;

    function connect(matchId) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {

            stompClient.subscribe('/topic/events', msg => {
                prependEvent(JSON.parse(msg.body));
            });

            stompClient.subscribe(`/topic/match/${matchId}/score`, msg => {
                const m = JSON.parse(msg.body);
                document.getElementById('score').textContent =
                    `${m.homeScore} - ${m.awayScore} ( ${m.status} )`;
            });

            stompClient.subscribe('/topic/rankings', msg => {
                document.getElementById('ranking').textContent =
                    JSON.stringify(JSON.parse(msg.body), null, 2);
            });

        });
    }

    function prependEvent(ev) {
        const ul = document.getElementById('eventsList');
        const li = document.createElement('li');

        li.className = "bg-white p-3 rounded-lg shadow-sm border";

        li.textContent = `${ev.type} - ${ev.description || ""} (${ev.minute ? ev.minute + "'" : ""})`;

        ul.insertBefore(li, ul.firstChild);
    }

    document.getElementById('connect').addEventListener('click', () => {
        const id = document.getElementById('matchId').value;
        connect(id);

        fetch(`/api/matches/${id}/events`)
            .then(r => r.json())
            .then(list => {
                const ul = document.getElementById('eventsList');
                ul.innerHTML = '';
                list.reverse().forEach(prependEvent);
            });

        fetch(`/api/matches/${id}/score`)
            .then(r => r.json())
            .then(m => {
                document.getElementById('score').textContent =
                    `${m.homeScore} - ${m.awayScore} ( ${m.status} )`;
            });

        fetch(`/api/rankings`)
            .then(r => r.json())
            .then(ranking => {
                document.getElementById('ranking').textContent =
                    JSON.stringify(ranking, null, 2);
            });
    });
</script>

</body>
</html>
