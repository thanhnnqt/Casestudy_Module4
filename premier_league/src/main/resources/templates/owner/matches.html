<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout('BXH & L·ªãch Thi ƒê·∫•u', 'standings', ~{::content})">

<th:block th:fragment="content">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      prefix: 'tw-', // Th√™m prefix ƒë·ªÉ kh√¥ng xung ƒë·ªôt v·ªõi Bootstrap c·ªßa Layout
      theme: {
        extend: {
          colors: {
            primary: "#38003c",
            secondary: "#00ff85"
          }
        }
      },
      // T·∫Øt preflight ƒë·ªÉ kh√¥ng reset CSS c·ªßa Layout
      corePlugins: {
        preflight: false,
      }
    }
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <div class="tw-w-full tw-grid tw-grid-cols-1 lg:tw-grid-cols-3 tw-gap-8">

    <div class="lg:tw-col-span-2">
      <div class="tw-flex tw-items-center tw-justify-between tw-mb-6">
        <h1 class="tw-text-3xl tw-font-extrabold tw-text-primary tw-m-0">
          B·∫£ng X·∫øp H·∫°ng
        </h1>
        <span class="tw-bg-gray-200 tw-text-gray-600 tw-px-3 tw-py-1 tw-rounded-full tw-text-sm tw-font-semibold">Premier League 24/25</span>
      </div>

      <div class="tw-bg-white tw-shadow-lg tw-rounded-2xl tw-overflow-hidden tw-border tw-border-gray-200">
        <div class="tw-overflow-x-auto">
          <table class="tw-w-full">
            <thead class="tw-bg-primary tw-text-white tw-text-xs tw-uppercase">
            <tr>
              <th class="tw-py-3 tw-px-4 tw-text-center">#</th>
              <th class="tw-py-3 tw-px-4 tw-text-left">C√¢u l·∫°c b·ªô</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">Tr·∫≠n</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">T</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">H</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">B</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">HS</th>
              <th class="tw-py-3 tw-px-4 tw-text-center tw-font-bold">ƒêi·ªÉm</th>
            </tr>
            </thead>
            <tbody id="rankingBody" class="tw-text-gray-800 tw-text-sm">
            <tr>
              <td colspan="8" class="tw-text-center tw-py-8 tw-text-gray-400">
                ƒêang t·∫£i d·ªØ li·ªáu...
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tw-bg-white tw-shadow-lg tw-rounded-2xl tw-p-6 tw-border tw-border-gray-200 tw-h-fit">

      <h2 class="tw-text-xl tw-font-bold tw-text-primary tw-mb-4 tw-flex tw-items-center tw-gap-2">
        üìÖ L·ªãch Thi ƒê·∫•u
      </h2>

      <form method="get" action="/admin/owner/matches" class="tw-mb-5">
        <label class="tw-font-semibold tw-text-sm tw-text-gray-500 tw-mb-1 tw-block">Ch·ªçn v√≤ng ƒë·∫•u:</label>
        <select name="round"
                class="tw-w-full tw-p-2.5 tw-border tw-border-gray-300 tw-rounded-lg tw-bg-gray-50 tw-text-sm focus:tw-ring-primary focus:tw-border-primary"
                onchange="this.form.submit()">
          <option th:each="i : ${#numbers.sequence(1, 38)}"
                  th:value="${i}"
                  th:text="'V√≤ng ' + ${i}"
                  th:selected="${i == selectedRound}">
          </option>
        </select>
      </form>

      <div class="tw-space-y-3">
        <a th:each="match : ${upcomingMatches}"
           th:href="@{'/live_matches/' + ${match.id}}"
           class="tw-block tw-p-3 tw-border tw-rounded-xl tw-bg-gray-50 hover:tw-bg-white hover:tw-shadow-md tw-transition tw-group tw-no-underline">

          <div class="tw-flex tw-items-center tw-justify-between">
            <div class="tw-text-center tw-w-1/3">
              <div class="tw-w-12 tw-h-12 tw-bg-white tw-rounded-full tw-mx-auto tw-mb-2 tw-flex tw-items-center tw-justify-center tw-p-2 tw-shadow-sm">
                <img th:src="${match.homeTeam.logoUrl}" class="tw-w-full tw-h-full tw-object-contain"/>
              </div>
              <h3 class="tw-text-xs tw-font-bold tw-text-gray-800 tw-truncate" th:text="${match.homeTeam.shortName}">Home</h3>
            </div>

            <div class="tw-w-1/3 tw-text-center">
              <div class="tw-text-xl tw-font-black tw-text-gray-300 tw-mb-1">VS</div>

              <p class="tw-text-[10px] tw-text-gray-500 tw-font-medium tw-mb-1"
                 th:text="${#temporals.format(match.matchDate, 'dd/MM HH:mm')}">Time</p>

              <div class="tw-inline-flex tw-items-center tw-gap-1 tw-text-[10px] tw-font-bold tw-px-2 tw-py-0.5 tw-rounded-full"
                   th:classappend="${#strings.equalsIgnoreCase(match.status,'finished')} ? 'tw-bg-gray-200 tw-text-gray-600' : 'tw-bg-green-100 tw-text-green-700'">
                <i data-lucide="clock" class="tw-w-3 tw-h-3"></i>
                <span th:text="${#strings.equalsIgnoreCase(match.status,'finished') ? 'K·∫øt th√∫c' : 'S·∫Øp ƒë√°'}"></span>
              </div>
            </div>

            <div class="tw-text-center tw-w-1/3">
              <div class="tw-w-12 tw-h-12 tw-bg-white tw-rounded-full tw-mx-auto tw-mb-2 tw-flex tw-items-center tw-justify-center tw-p-2 tw-shadow-sm">
                <img th:src="${match.awayTeam.logoUrl}" class="tw-w-full tw-h-full tw-object-contain"/>
              </div>
              <h3 class="tw-text-xs tw-font-bold tw-text-gray-800 tw-truncate" th:text="${match.awayTeam.shortName}">Away</h3>
            </div>
          </div>
        </a>

        <div th:if="${#lists.isEmpty(upcomingMatches)}" class="tw-text-center tw-py-6 tw-text-gray-400 tw-text-sm tw-italic">
          <i data-lucide="calendar-x" class="tw-w-8 tw-h-8 tw-mx-auto tw-mb-2 tw-opacity-50"></i>
          Kh√¥ng c√≥ l·ªãch thi ƒë·∫•u v√≤ng n√†y.
        </div>
      </div>

    </div>

  </div>

  <script>
    const body = document.getElementById("rankingBody");

    async function loadRanking() {
      try {
        // G·ªçi API l·∫•y d·ªØ li·ªáu BXH
        const res = await fetch("/api/rankings/v1");
        const data = await res.json();

        body.innerHTML = "";

        data.forEach((r, index) => {
          const tr = document.createElement("tr");
          tr.className = "tw-border-b tw-border-gray-100 hover:tw-bg-gray-50 tw-transition";

          // Highlight Top 4 & Xu·ªëng h·∫°ng
          let posClass = "tw-text-gray-500";
          let rowBg = "";

          if(index < 4) {
            posClass = "tw-text-white tw-bg-primary tw-w-6 tw-h-6 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-text-xs";
            // S·ª≠a l·∫°i logic hi·ªÉn th·ªã s·ªë th·ª© t·ª± cho ƒë·∫πp
            var posHtml = `<div class="${posClass}">${index + 1}</div>`;
          } else if (index >= 17) {
            posHtml = `<div class="tw-text-red-500 tw-font-bold">${index + 1}</div>`;
          } else {
            posHtml = `<div class="${posClass}">${index + 1}</div>`;
          }

          tr.innerHTML = `
                        <td class="tw-py-3 tw-px-4 tw-text-center">${posHtml}</td>

                        <td class="tw-py-3 tw-px-4">
                            <div class="tw-flex tw-items-center tw-gap-3">
                                <img src="${r.logoUrl}" class="tw-w-8 tw-h-8 tw-object-contain" />
                                <a href="/team/${r.id}" class="tw-font-bold tw-text-gray-800 hover:tw-text-primary tw-no-underline tw-transition">${r.name}</a>
                            </div>
                        </td>

                        <td class="tw-py-3 tw-px-4 tw-text-center tw-font-medium">${(r.winCount||0) + (r.drawCount||0) + (r.loseCount||0)}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-green-600">${r.winCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-gray-500">${r.drawCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-red-500">${r.loseCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center">${r.goalDifference > 0 ? '+' + r.goalDifference : r.goalDifference}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-font-black tw-text-lg tw-text-primary">${r.points}</td>
                    `;

          body.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        body.innerHTML = `<tr><td colspan="8" class="tw-text-center tw-py-4 tw-text-red-500">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>`;
      }
    }

    loadRanking();

    // WebSocket Realtime
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);
    stomp.debug = null;

    stomp.connect({}, () => {
      stomp.subscribe('/topic/ranking-updated', () => {
        body.classList.add('tw-opacity-50');
        setTimeout(() => body.classList.remove('tw-opacity-50'), 300);
        loadRanking();
      });
    });

    lucide.createIcons();
  </script>

</th:block>
</html>