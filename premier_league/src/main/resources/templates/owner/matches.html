<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout('B·∫£ng X·∫øp H·∫°ng & L·ªãch ƒê·∫•u', 'dashboard', ~{::content})">

<th:block th:fragment="content">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      prefix: 'tw-', // Th√™m prefix ƒë·ªÉ tr√°nh xung ƒë·ªôt v·ªõi Bootstrap c·ªßa Layout
      theme: {
        extend: {
          colors: {
            primary: "#38003c",
            secondary: "#00ff85"
          }
        }
      },
      corePlugins: {
        preflight: false, // T·∫Øt reset CSS c·ªßa Tailwind ƒë·ªÉ kh√¥ng h·ªèng style c·ªßa Layout
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <div class="tw-w-full tw-grid tw-grid-cols-1 lg:tw-grid-cols-3 tw-gap-8">

    <div class="lg:tw-col-span-2">
      <div class="tw-bg-white tw-shadow-sm tw-rounded-2xl tw-overflow-hidden tw-border tw-border-gray-200">
        <div class="tw-bg-primary tw-p-4 tw-flex tw-items-center tw-justify-between">
          <h2 class="tw-text-xl tw-font-bold tw-text-white tw-m-0">
            üèÜ B·∫£ng X·∫øp H·∫°ng
          </h2>
          <span class="tw-text-xs tw-text-gray-300 tw-uppercase tw-font-semibold">Season 2024-2025</span>
        </div>

        <div class="tw-overflow-x-auto">
          <table class="tw-w-full tw-text-sm">
            <thead class="tw-bg-gray-50 tw-text-gray-500 tw-uppercase tw-text-xs">
            <tr>
              <th class="tw-py-3 tw-px-4 tw-text-center">#</th>
              <th class="tw-py-3 tw-px-4 tw-text-left">C√¢u l·∫°c b·ªô</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">Tr·∫≠n</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">T</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">H</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">B</th>
              <th class="tw-py-3 tw-px-4 tw-text-center">HS</th>
              <th class="tw-py-3 tw-px-4 tw-text-center tw-font-bold tw-text-primary">ƒêi·ªÉm</th>
            </tr>
            </thead>
            <tbody id="rankingBody" class="tw-text-gray-700">
            <tr>
              <td colspan="8" class="tw-text-center tw-py-8 tw-text-gray-400">
                ƒêang t·∫£i d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng...
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tw-space-y-6">
      <div class="tw-bg-white tw-shadow-sm tw-rounded-2xl tw-p-5 tw-border tw-border-gray-200">
        <h2 class="tw-text-lg tw-font-bold tw-text-primary tw-mb-4 tw-flex tw-items-center tw-gap-2">
          üìÖ L·ªãch Thi ƒê·∫•u
        </h2>

        <form method="get" action="#" class="tw-mb-4">
          <select name="round"
                  class="tw-w-full tw-p-2.5 tw-border tw-border-gray-300 tw-rounded-lg tw-bg-gray-50 tw-text-sm focus:tw-ring-primary focus:tw-border-primary"
                  onchange="this.form.submit()">
            <option th:each="i : ${#numbers.sequence(1, 38)}"
                    th:value="${i}"
                    th:text="'V√≤ng ' + ${i}"
                    th:selected="${i == selectedRound}">
            </option>
          </select>
        </form>

        <div class="tw-space-y-3">
          <div th:each="match : ${upcomingMatches}"
               class="tw-p-3 tw-border tw-rounded-xl tw-bg-gray-50 hover:tw-bg-white hover:tw-shadow-md tw-transition tw-duration-200 tw-group">

            <div class="tw-flex tw-items-center tw-justify-between">
              <div class="tw-flex tw-flex-col tw-items-center tw-w-1/3">
                <img th:src="${match.homeTeam.logoUrl}" class="tw-w-8 tw-h-8 tw-object-contain tw-mb-1"/>
                <span class="tw-text-xs tw-font-bold tw-text-gray-800 tw-truncate tw-w-full tw-text-center"
                      th:text="${match.homeTeam.shortName}">ARS</span>
              </div>

              <div class="tw-w-1/3 tw-text-center">
                <div class="tw-text-xs tw-font-bold tw-bg-primary tw-text-white tw-px-2 tw-py-0.5 tw-rounded-full tw-inline-block tw-mb-1">
                  VS
                </div>
                <div class="tw-text-[10px] tw-text-gray-500 tw-font-medium"
                     th:text="${#temporals.format(match.matchDate, 'HH:mm')}">20:00</div>
                <div class="tw-text-[10px] tw-text-gray-400"
                     th:text="${#temporals.format(match.matchDate, 'dd/MM')}">12/03</div>
              </div>

              <div class="tw-flex tw-flex-col tw-items-center tw-w-1/3">
                <img th:src="${match.awayTeam.logoUrl}" class="tw-w-8 tw-h-8 tw-object-contain tw-mb-1"/>
                <span class="tw-text-xs tw-font-bold tw-text-gray-800 tw-truncate tw-w-full tw-text-center"
                      th:text="${match.awayTeam.shortName}">MCI</span>
              </div>
            </div>
          </div>

          <div th:if="${#lists.isEmpty(upcomingMatches)}" class="tw-text-center tw-py-4 tw-text-gray-400 tw-text-sm">
            Ch∆∞a c√≥ l·ªãch ƒë·∫•u cho v√≤ng n√†y.
          </div>
        </div>
      </div>

      <div class="tw-bg-gradient-to-r tw-from-primary tw-to-purple-900 tw-rounded-2xl tw-p-5 tw-text-white tw-text-center tw-shadow-lg">
        <h3 class="tw-font-bold tw-text-lg tw-mb-1">Fantasy Premier League</h3>
        <p class="tw-text-xs tw-opacity-80 tw-mb-3">X√¢y d·ª±ng ƒë·ªôi h√¨nh trong m∆° c·ªßa b·∫°n ngay h√¥m nay!</p>
        <button class="tw-bg-secondary tw-text-primary tw-font-bold tw-text-xs tw-py-2 tw-px-4 tw-rounded-full hover:tw-bg-white tw-transition">
          Ch∆°i Ngay
        </button>
      </div>
    </div>
  </div>

  <script>
    const body = document.getElementById("rankingBody");

    async function loadRanking() {
      try {
        // G·ªçi API l·∫•y d·ªØ li·ªáu BXH (ƒê·∫£m b·∫£o b·∫°n c√≥ API n√†y)
        const res = await fetch("/api/rankings/v1");
        if (!res.ok) throw new Error("API Error");

        const data = await res.json();
        body.innerHTML = "";

        data.forEach((r, index) => {
          const tr = document.createElement("tr");
          tr.className = "tw-border-b tw-border-gray-100 hover:tw-bg-gray-50 tw-transition";

          // Highlight Top 4 (C1) v√† Bottom 3 (Xu·ªëng h·∫°ng)
          let posClass = "tw-text-gray-600";
          if(index < 4) posClass = "tw-text-primary tw-font-bold";
          if(index >= 17) posClass = "tw-text-red-500";

          tr.innerHTML = `
                        <td class="tw-py-3 tw-px-4 tw-text-center ${posClass}">${index + 1}</td>
                        <td class="tw-py-3 tw-px-4">
                            <div class="tw-flex tw-items-center tw-gap-3">
                                <img src="${r.logoUrl}" class="tw-w-6 tw-h-6 tw-object-contain" />
                                <span class="tw-font-semibold tw-text-gray-800">${r.name}</span>
                            </div>
                        </td>
                        <td class="tw-py-3 tw-px-4 tw-text-center">${(r.winCount || 0) + (r.drawCount || 0) + (r.loseCount || 0)}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-green-600">${r.winCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-gray-500">${r.drawCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-text-red-500">${r.loseCount ?? 0}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-font-medium">${r.goalDifference > 0 ? '+' + r.goalDifference : r.goalDifference}</td>
                        <td class="tw-py-3 tw-px-4 tw-text-center tw-font-bold tw-text-lg tw-text-primary">${r.points}</td>
                    `;
          body.appendChild(tr);
        });
      } catch (e) {
        body.innerHTML = `<tr><td colspan="8" class="tw-text-center tw-py-4 tw-text-red-500">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</td></tr>`;
      }
    }

    // Load b·∫£ng khi m·ªü trang
    loadRanking();

    // WebSocket Realtime (Gi·ªØ nguy√™n)
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);
    stomp.debug = null; // T·∫Øt log debug cho g·ªçn console

    stomp.connect({}, () => {
      stomp.subscribe('/topic/ranking-updated', () => {
        // Hi·ªáu ·ª©ng nh√°y b·∫£ng khi c√≥ update
        body.classList.add('tw-opacity-50');
        setTimeout(() => body.classList.remove('tw-opacity-50'), 300);
        loadRanking();
      });
    });
  </script>

</th:block>
</html>