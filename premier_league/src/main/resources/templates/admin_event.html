<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Admin - Th√™m S·ª± Ki·ªán Tr·∫≠n ƒê·∫•u</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#38003c',
                        secondary: '#00ff85',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- Nh·∫≠n matchId t·ª´ controller -->
<div id="root" th:attr="data-match-id=${matchId}"></div>

<!-- NAVBAR -->
<div th:replace="layout/navbar :: header"></div>

<!-- CONTENT -->
<div class="max-w-3xl mx-auto p-6 bg-white mt-10 shadow-xl rounded-2xl border-t-4 border-primary">

    <h2 class="text-3xl font-bold text-primary mb-6 flex items-center gap-2">
        <i data-lucide="settings" class="w-7 h-7 text-secondary"></i>
        Th√™m S·ª± Ki·ªán Tr·∫≠n ƒê·∫•u (Admin)
    </h2>

    <div class="space-y-4">

        <!-- MATCH ID -->
        <div>
            <label class="font-semibold">Match ID</label>
            <input id="matchId"
                   class="w-full mt-1 px-4 py-3 border rounded-lg focus:border-primary" />
        </div>

        <!-- SELECT TEAM -->
        <div>
            <label class="font-semibold">Ch·ªçn ƒê·ªôi</label>
            <select id="teamSelect"
                    class="w-full mt-1 px-4 py-3 border rounded-lg bg-gray-50 focus:border-primary">
                <option value="">-- Ch·ªçn ƒë·ªôi --</option>
            </select>
        </div>

        <!-- SELECT PLAYER -->
        <div>
            <label class="font-semibold">Ch·ªçn C·∫ßu Th·ªß</label>
            <select id="playerSelect"
                    class="w-full mt-1 px-4 py-3 border rounded-lg bg-gray-50 focus:border-primary">
                <option value="">-- Ch·ªçn c·∫ßu th·ªß --</option>
            </select>
        </div>

        <!-- MINUTE -->
        <div>
            <label class="font-semibold">Ph√∫t</label>
            <input id="minute" type="number"
                   class="w-full mt-1 px-4 py-3 border rounded-lg focus:border-primary"
                   placeholder="Ph√∫t x·∫£y ra"/>
        </div>

        <!-- EVENT TYPE -->
        <div>
            <label class="font-semibold">Lo·∫°i S·ª± Ki·ªán</label>
            <select id="type"
                    class="w-full mt-1 px-4 py-3 border rounded-lg focus:border-primary">
                <option value="GOAL">B√†n th·∫Øng</option>
                <option value="YELLOW_CARD">Th·∫ª v√†ng</option>
                <option value="RED_CARD">Th·∫ª ƒë·ªè</option>
                <option value="PENALTY">Ph·∫°t ƒë·ªÅn</option>
                <option value="MATCH_END">K·∫øt th√∫c tr·∫≠n ƒë·∫•u</option>
            </select>
        </div>

        <!-- DESCRIPTION -->
        <div>
            <label class="font-semibold">M√¥ t·∫£</label>
            <input id="desc" type="text"
                   class="w-full mt-1 px-4 py-3 border rounded-lg focus:border-primary"
                   placeholder="V√≠ d·ª•: 'Ghi b√†n ƒë·∫πp m·∫Øt t·ª´ ngo√†i v√≤ng c·∫•m'"/>
        </div>

        <button id="send"
                class="w-full py-3 bg-primary text-white font-bold rounded-lg hover:bg-secondary hover:text-primary transition">
            G·ª≠i S·ª± Ki·ªán
        </button>
    </div>
</div>

<div class="mt-auto" th:replace="layout/footer :: footer"></div>

<script>
    lucide.createIcons();

    /* ===========================
       L·∫§Y matchId T·ª™ CONTROLLER
    ============================ */
    const matchIdFromServer = document.getElementById("root").dataset.matchId;

    if (matchIdFromServer) {
        document.getElementById("matchId").value = matchIdFromServer;
        loadTeams();
    }

    async function loadTeams() {
        const matchId = document.getElementById("matchId").value;
        if (!matchId) return;

        const res = await fetch(`/api/matches/${matchId}`);
        const match = await res.json();

        const teamSelect = document.getElementById("teamSelect");
        teamSelect.innerHTML = `
            <option value="">-- Ch·ªçn ƒë·ªôi --</option>
            <option value="${match.homeTeamId}">${match.homeTeamName}</option>
            <option value="${match.awayTeamId}">${match.awayTeamName}</option>
        `;
    }

    async function loadPlayers(teamId) {
        const playerSelect = document.getElementById("playerSelect");

        if (!teamId) {
            playerSelect.innerHTML = `<option value="">-- Ch·ªçn c·∫ßu th·ªß --</option>`;
            return;
        }

        const res = await fetch(`/api/teams/${teamId}/players`);
        const players = await res.json();

        playerSelect.innerHTML = `<option value="">-- Ch·ªçn c·∫ßu th·ªß --</option>`;
        players.forEach(p => {
            playerSelect.innerHTML += `
                <option value="${p.id}">${p.name} (${p.position})</option>
            `;
        });
    }

    document.getElementById("teamSelect").addEventListener("change", e => {
        loadPlayers(e.target.value);
    });

    document.getElementById('send').addEventListener('click', async () => {

        const matchId = +document.getElementById('matchId').value;
        const minute = document.getElementById('minute').value;
        const type = document.getElementById('type').value;
        const desc = document.getElementById('desc').value;

        const teamId = document.getElementById('teamSelect').value;
        const playerId = document.getElementById('playerSelect').value;

        if (!matchId) return alert("‚õî Ph·∫£i nh·∫≠p Match ID!");
        if (!minute) return alert("‚õî Ph·∫£i nh·∫≠p ph√∫t!");

        if (type === "GOAL" && !teamId) return alert("‚õî Ghi b√†n ph·∫£i ch·ªçn ƒë·ªôi!");
        if (type === "GOAL" && !playerId) return alert("‚õî Ghi b√†n ph·∫£i ch·ªçn c·∫ßu th·ªß!");

        const payload = {
            teamId: teamId || null,
            playerId: playerId || null,
            minute: minute,
            type: type,
            description: desc
        };

        // g·ª≠i s·ª± ki·ªán
        const resp = await fetch(`/api/matches/${matchId}/events`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            const msg = await resp.text();
            return alert("‚ùå L·ªói: " + msg);
        }

        // n·∫øu MATCH_END ‚Üí c·∫≠p nh·∫≠t tr·∫°ng th√°i lu√¥n
        if (type === "MATCH_END") {
            await fetch(`/admin/matches/finish/${matchId}`, {
                method: "POST"
            });

            alert("üèÅ Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c!");
            window.location.href = "/admin/matches";
            return;
        }

        alert("‚úÖ Th√†nh c√¥ng!");
    });


</script>

</body>
</html>
