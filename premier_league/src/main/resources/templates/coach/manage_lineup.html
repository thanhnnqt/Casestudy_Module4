<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý đội hình - <span th:text="${teamName}"></span></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #f4f7f6;
        }
        .lineup-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        /* 1. DANH SÁCH CẦU THỦ BÊN TRÁI */
        .player-list-sidebar {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            height: 85vh;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .player-list-sidebar .nav-pills .nav-link {
            font-size: 0.9rem;
            padding: 0.5rem 0.8rem;
        }
        .player-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: grab;
            transition: background-color 0.2s;
            border: 1px solid #eee;
        }
        .player-item:hover {
            background-color: #f0f0f0;
        }
        .player-item[draggable="true"]:active {
            cursor: grabbing;
        }
        .player-item.dragging {
            opacity: 0.5;
            background: #cce5ff;
        }
        .player-item .position {
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            background: #0d6efd;
            border-radius: 4px;
            padding: 2px 6px;
            min-width: 35px;
            text-align: center;
            margin-right: 10px;
        }
        /* Màu vị trí */
        .player-item[data-pos="GK"] .position { background: #f0ad4e; }
        .player-item[data-pos="DF"] .position { background: #5cb85c; }
        .player-item[data-pos="MF"] .position { background: #0275d8; }
        .player-item[data-pos="FW"] .position { background: #d9534f; }

        /* --- 2. SÂN BÓNG BÊN PHẢI (VẼ BẰNG CSS) --- */
        .pitch-area {
            /* Nền cỏ xanh */
            background-color: #438a38;
            background-image: repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 20px, transparent 20px 40px);

            height: 600px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 4px solid #fff; /* Đường biên bao quanh */
            overflow: hidden; /* Cắt các phần dư */
            user-select: none;
        }

        /* Vạch kẻ sân (Màu trắng mờ) */
        .pitch-marking {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.8);
            pointer-events: none; /* Để không chặn click vào cầu thủ */
        }

        /* Đường giữa sân */
        .pitch-halfway-line {
            top: 0; bottom: 0; left: 50%;
            width: 0;
            border-left: 2px solid rgba(255, 255, 255, 0.8);
            transform: translateX(-50%);
        }

        /* Vòng tròn trung tâm */
        .pitch-center-circle {
            top: 50%; left: 50%;
            width: 120px; height: 120px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Chấm giao bóng */
        .pitch-center-spot {
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Khu cấm địa (Vòng 16m50) - Trái */
        .pitch-penalty-left {
            top: 50%; left: 0;
            width: 16%; height: 55%;
            transform: translateY(-50%);
            border-left: none;
        }

        /* Khu cấm địa (Vòng 16m50) - Phải */
        .pitch-penalty-right {
            top: 50%; right: 0;
            width: 16%; height: 55%;
            transform: translateY(-50%);
            border-right: none;
        }

        /* Khu cầu môn (Vòng 5m50) - Trái */
        .pitch-goal-area-left {
            top: 50%; left: 0;
            width: 6%; height: 25%;
            transform: translateY(-50%);
            border-left: none;
        }

        /* Khu cầu môn (Vòng 5m50) - Phải */
        .pitch-goal-area-right {
            top: 50%; right: 0;
            width: 6%; height: 25%;
            transform: translateY(-50%);
            border-right: none;
        }

        /* Cầu thủ trên sân */
        .player-slot {
            position: absolute;
            width: 90px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            z-index: 10;
        }

        /* Sửa lỗi hiển thị tên cầu thủ khi hover (theo yêu cầu trước) */
        .player-slot .player-item:hover {
            background-color: #2c0030 !important; /* Tím đậm */
            color: #00ff85 !important;           /* Xanh neon */
            border-color: #00ff85 !important;
            transform: scale(1.05);
            z-index: 100;
        }

        .player-slot.drag-over {
            background: rgba(0, 255, 133, 0.7);
            border: 2px solid #fff;
            transform: scale(1.1);
        }
        .player-slot.filled {
            border: 2px solid #00ff85;
            background: rgba(56, 0, 60, 0.9);
            color: white;
            border-radius: 8px;
            width: 110px;
            height: auto;
            padding: 6px 4px;
            font-size: 0.85rem;
            text-align: center;
            cursor: grab;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .player-slot.filled:active { cursor: grabbing; }
        .player-slot.filled .slot-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #00ff85;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .player-slot .slot-label {
            font-weight: bold;
            color: #fff;
            font-size: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* VỊ TRÍ CẦU THỦ TRÊN SÂN (Horizontal Layout) */
        /* 4-4-2 */
        .formation[data-formation="4-4-2"] .slot-GK  { top: 50%; left: 8%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-4-2"] .slot-LB  { top: 15%; left: 25%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-LCB { top: 38%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-RCB { top: 62%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-RB  { top: 85%; left: 25%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-4-2"] .slot-LM  { top: 15%; left: 50%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-LCM { top: 38%; left: 45%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-RCM { top: 62%; left: 45%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-RM  { top: 85%; left: 50%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-4-2"] .slot-LST { top: 35%; left: 75%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-4-2"] .slot-RST { top: 65%; left: 75%; transform: translate(-50%, -50%); }

        /* 4-3-3 */
        .formation[data-formation="4-3-3"] .slot-GK  { top: 50%; left: 8%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-LB  { top: 15%; left: 25%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-LCB { top: 38%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-RCB { top: 62%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-RB  { top: 85%; left: 25%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-3-3"] .slot-LCM { top: 30%; left: 48%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-CM  { top: 50%; left: 40%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-RCM { top: 70%; left: 48%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-3-3"] .slot-LW  { top: 20%; left: 75%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-ST  { top: 50%; left: 80%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-3-3"] .slot-RW  { top: 80%; left: 75%; transform: translate(-50%, -50%); }

        /* 4-2-3-1 */
        .formation[data-formation="4-2-3-1"] .slot-GK  { top: 50%; left: 8%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-LB  { top: 15%; left: 25%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-LCB { top: 38%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-RCB { top: 62%; left: 22%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-RB  { top: 85%; left: 25%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-2-3-1"] .slot-LDM { top: 35%; left: 42%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-RDM { top: 65%; left: 42%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-2-3-1"] .slot-LAM { top: 20%; left: 65%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-CAM { top: 50%; left: 60%; transform: translate(-50%, -50%); }
        .formation[data-formation="4-2-3-1"] .slot-RAM { top: 80%; left: 65%; transform: translate(-50%, -50%); }

        .formation[data-formation="4-2-3-1"] .slot-ST  { top: 50%; left: 82%; transform: translate(-50%, -50%); }


        /* --- 3. GHẾ DỰ BỊ --- */
        .bench-area {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .bench-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .bench-slot {
            width: 100px;
            height: 60px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: #888;
            background: #f8f9fa;
        }
        .bench-slot.drag-over {
            background: #cce5ff;
            border-color: #0d6efd;
        }
        .bench-slot.filled {
            border: 1px solid #0d6efd;
            padding: 5px;
            background: #e7f1ff;
            color: #000;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: grab;
            text-align: center;
        }
        .bench-slot.filled .position {
            font-size: 0.7rem; font-weight: bold; color: #0d6efd;
        }

    </style>
</head>
<body>
<div class="container-fluid my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">SƠ ĐỒ CHIẾN THUẬT: <span class="text-primary" th:text="${teamName}"></span></h2>
            <p class="fs-5 text-muted"
               th:text="'Trận: ' + ${match.homeTeam.name} + ' vs ' + ${match.awayTeam.name}">
                Trận đấu
            </p>
        </div>
        <div>
            <label for="formation-select" class="form-label fw-bold">Chọn sơ đồ:</label>
            <select id="formation-select" class="form-select form-select-lg" style="width: 200px;">
                <option th:each="f : ${formations}"
                        th:value="${f.key}"
                        th:text="${f.key}"
                        th:selected="${f.key == currentFormationName}">
                </option>
            </select>
        </div>
    </div>

    <form id="lineup-form"
          th:action="@{/coach/team/{teamId}/match/{matchId}/tactics/save(teamId=${teamId}, matchId=${match.id})}"
          method="post">

        <div class="lineup-container">

            <div class="player-list-sidebar" id="player-list-pool">
                <h5>Danh sách cầu thủ (<span id="available-count"></span>)</h5>

                <ul class="nav nav-pills nav-fill my-3" id="pos-filter">
                    <li class="nav-item"><a class="nav-link active" href="#" data-pos="ALL">Tất cả</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-pos="GK" style="background-color: #f0ad4e; color: white;">GK</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-pos="DF" style="background-color: #5cb85c; color: white;">DF</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-pos="MF" style="background-color: #0275d8; color: white;">MF</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-pos="FW" style="background-color: #d9534f; color: white;">FW</a></li>
                </ul>

                <div id="available-players">
                    <div th:each="p : ${availablePlayers}"
                         class="player-item"
                         th:data-player-id="${p.id}"
                         th:data-player-name="${p.name}"
                         th:data-pos="${p.position}"
                         draggable="true">
                        <span class="position" th:text="${p.position}"></span>
                        <span class="name" th:text="${p.name}"></span>
                    </div>
                </div>
            </div>

            <div class="pitch-and-bench">
                <div class="pitch-area">
                    <div class="pitch-marking pitch-halfway-line"></div>
                    <div class="pitch-marking pitch-center-circle"></div>
                    <div class="pitch-marking pitch-center-spot"></div>
                    <div class="pitch-marking pitch-penalty-left"></div>
                    <div class="pitch-marking pitch-penalty-right"></div>
                    <div class="pitch-marking pitch-goal-area-left"></div>
                    <div class="pitch-marking pitch-goal-area-right"></div>

                    <div th:each="f : ${formations}"
                         th:id="'formation-' + ${f.key}"
                         class="formation"
                         th:data-formation="${f.key}"
                         th:style="${f.key == currentFormationName} ? '' : 'display: none;'">

                        <div th:each="pos : ${f.value.positions}"
                             class="player-slot"
                             th:classappend="'slot-' + ${pos.key}"
                             th:data-slot-pos="${pos.key}">
                            <span class="slot-label" th:text="${pos.value}"></span>
                        </div>
                    </div>
                </div>

                <div class="bench-area">
                    <h5>Ghế dự bị (<span id="bench-count">0</span>/9)</h5>
                    <div class="bench-slots" id="bench-slots-container">
                        <div class="bench-slot" data-slot-pos="SUB_1"><span class="slot-label">Dự bị 1</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_2"><span class="slot-label">Dự bị 2</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_3"><span class="slot-label">Dự bị 3</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_4"><span class="slot-label">Dự bị 4</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_5"><span class="slot-label">Dự bị 5</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_6"><span class="slot-label">Dự bị 6</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_7"><span class="slot-label">Dự bị 7</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_8"><span class="slot-label">Dự bị 8</span></div>
                        <div class="bench-slot" data-slot-pos="SUB_9"><span class="slot-label">Dự bị 9</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hidden-inputs"></div>

        <div class="mt-4 d-flex justify-content-end gap-2">
            <button type="button" id="reset-button" class="btn btn-warning btn-lg text-white shadow-sm">
                <i class="bi bi-arrow-counterclockwise"></i> Xếp lại
            </button>

            <a th:href="@{/coach/team/{teamId}/schedule(teamId=${teamId})}" class="btn btn-secondary btn-lg">Quay lại</a>
            <button type="button" id="save-button" class="btn btn-primary btn-lg" disabled>
                Phải có đủ 11 cầu thủ chính
            </button>
        </div>

    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const initialMainPlayers = /*[[${mainPlayers}]]*/ [];
    const initialSubPlayers = /*[[${subPlayers}]]*/ [];
    const allFormations = /*[[${formations}]]*/ {};
    const redirectAfterSave = /*[[ @{/coach/team/{teamId}/schedule(teamId=${teamId})} ]]*/ '/';
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === 1. KHAI BÁO BIẾN ===
        let draggedItem = null;
        const playerPool = document.getElementById('available-players');
        const pitchSlots = document.querySelectorAll('.player-slot');
        const benchSlots = document.querySelectorAll('.bench-slot');
        const allDropZones = [...pitchSlots, ...benchSlots, playerPool];
        const saveButton = document.getElementById('save-button');
        const formationSelect = document.getElementById('formation-select');
        const formEl = document.getElementById('lineup-form');
        const resetButton = document.getElementById('reset-button');

        // CSRF detection
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
        const csrfHeaderName = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : (csrfToken ? 'X-CSRF-TOKEN' : null);

        // === 2. HÀM HỖ TRỢ ===
        function createPlayerElement(id, name, pos) {
            const el = document.createElement('div');
            el.className = 'player-item';
            el.draggable = true;
            el.dataset.playerId = id;
            el.dataset.playerName = name;
            el.dataset.pos = pos;
            el.innerHTML = `<span class="position">${pos}</span> <span class="name">${name}</span>`;
            addDragEventsToPlayer(el);
            return el;
        }
        function createFilledSlotElement(id, name, pos, slotLabel) {
            const el = document.createElement('div');
            el.className = 'player-item';
            el.draggable = true;
            el.dataset.playerId = id;
            el.dataset.playerName = name;
            el.dataset.pos = pos;
            el.innerHTML = `<div class="slot-label">${slotLabel}</div> <span class="name">${name}</span>`;
            addDragEventsToPlayer(el);
            return el;
        }
        function createFilledBenchElement(id, name, pos) {
            const el = document.createElement('div');
            el.className = 'player-item';
            el.draggable = true;
            el.dataset.playerId = id;
            el.dataset.playerName = name;
            el.dataset.pos = pos;
            el.innerHTML = `<span class="position">${pos}</span> <span class="name">${name}</span>`;
            addDragEventsToPlayer(el);
            return el;
        }
        function clearSlot(slot) {
            if (!slot) return;
            if(slot.classList.contains('bench-slot')) {
                slot.innerHTML = `<span class="slot-label">Dự bị ${slot.dataset.slotPos.split('_')[1]}</span>`;
            } else {
                const activeFormation = document.querySelector('.formation:not([style*="display: none"])');
                if (!activeFormation) return;
                const formationName = activeFormation.dataset.formation;
                const slotKey = slot.dataset.slotPos;
                const slotLabel = allFormations[formationName].positions[slotKey] || '';
                slot.innerHTML = `<span class="slot-label">${slotLabel}</span>`;
            }
            slot.classList.remove('filled');
        }

        // === 3. Drag & Drop ===
        function addDragEventsToPlayer(player) {
            player.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });
            player.addEventListener('dragend', () => {
                if (draggedItem) { draggedItem.classList.remove('dragging'); }
                draggedItem = null;
            });
        }
        document.querySelectorAll('.player-item').forEach(addDragEventsToPlayer);

        allDropZones.forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (canDrop(draggedItem, zone)) zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (!canDrop(draggedItem, zone)) return;
                const data = {
                    id: draggedItem.dataset.playerId,
                    name: draggedItem.dataset.playerName,
                    pos: draggedItem.dataset.pos
                };
                const originalSlot = draggedItem.closest('.player-slot, .bench-slot');
                if (originalSlot) clearSlot(originalSlot);
                else draggedItem.remove();

                if (zone.id === 'available-players') {
                    zone.appendChild(createPlayerElement(data.id, data.name, data.pos));
                } else if (zone.classList.contains('player-slot')) {
                    const slotLabel = zone.querySelector('.slot-label') ? zone.querySelector('.slot-label').innerText : '';
                    zone.innerHTML = '';
                    zone.appendChild(createFilledSlotElement(data.id, data.name, data.pos, slotLabel));
                    zone.classList.add('filled');
                } else if (zone.classList.contains('bench-slot')) {
                    zone.innerHTML = '';
                    zone.appendChild(createFilledBenchElement(data.id, data.name, data.pos));
                    zone.classList.add('filled');
                }
                updateAllCounts();
            });
        });

        function canDrop(item, zone) {
            if (!item) return false;
            if (zone.classList.contains('filled')) return false;
            if (zone.classList.contains('bench-slot')) {
                const filledBenchSlots = document.querySelectorAll('.bench-slot.filled').length;
                if (filledBenchSlots >= 9 && !item.closest('.bench-slot')) return false;
            }
            if (zone.classList.contains('player-slot')) {
                const filledPitchSlots = document.querySelectorAll('.player-slot.filled').length;
                const activeFormation = document.querySelector('.formation:not([style*="display: none"])');
                if (activeFormation) {
                    const totalSlotsInFormation = activeFormation.querySelectorAll('.player-slot').length;
                    if (filledPitchSlots >= totalSlotsInFormation && !item.closest('.player-slot')) return false;
                }
            }
            return true;
        }

        // === 4. Change formation ===
        formationSelect.addEventListener('change', (e) => {
            const newFormationName = e.target.value;
            document.querySelectorAll('.formation').forEach(f => f.style.display = 'none');
            const newFormationEl = document.getElementById('formation-' + newFormationName);
            if (newFormationEl) newFormationEl.style.display = 'block';
            newFormationEl.querySelectorAll('.player-slot.filled').forEach(slot => {
                const slotKey = slot.dataset.slotPos;
                const slotLabel = allFormations[newFormationName].positions[slotKey];
                const labelSpan = slot.querySelector('.slot-label');
                if (labelSpan) labelSpan.innerText = slotLabel;
            });
        });

        // === 5. Filter vị trí ===
        document.getElementById('pos-filter').addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.tagName !== 'A') return;
            document.querySelectorAll('#pos-filter .nav-link').forEach(a => a.classList.remove('active'));
            e.target.classList.add('active');
            const posFilter = e.target.dataset.pos;
            document.querySelectorAll('#available-players .player-item').forEach(playerEl => {
                if (posFilter === 'ALL' || playerEl.dataset.pos === posFilter) playerEl.style.display = 'flex';
                else playerEl.style.display = 'none';
            });
        });

        // === 6. Validate & Submit (AJAX) ===
        function updateAllCounts() {
            const availableCount = document.querySelectorAll('#available-players .player-item').length;
            document.getElementById('available-count').innerText = availableCount;
            const mainCount = document.querySelectorAll('.player-slot.filled .player-item').length;
            const subCount = document.querySelectorAll('.bench-slot.filled .player-item').length;
            document.getElementById('bench-count').innerText = subCount;

            // Enable only when mainCount === 11 AND at least 1 sub
            if (mainCount === 11 && subCount >= 1) {
                saveButton.disabled = false;
                saveButton.innerText = `Lưu đội hình (${mainCount} chính, ${subCount} dự bị)`;
            } else {
                saveButton.disabled = true;
                if (mainCount !== 11) saveButton.innerText = 'Phải có đủ 11 cầu thủ chính';
                else saveButton.innerText = 'Cần ít nhất 1 cầu thủ dự bị';
            }
        }

        saveButton.addEventListener('click', async (e) => {
            e.preventDefault();

            const mainPlayers = document.querySelectorAll('.player-slot.filled .player-item');
            const subPlayers = document.querySelectorAll('.bench-slot.filled .player-item');

            if (mainPlayers.length !== 11) {
                Swal.fire({ icon: 'error', title: 'Đội hình không hợp lệ', text: 'Đội hình chính phải có đúng 11 cầu thủ.'});
                return;
            }
            if (subPlayers.length < 1) {
                Swal.fire({ icon: 'error', title: 'Thiếu dự bị', text: 'Phải có tối thiểu 1 cầu thủ dự bị.'});
                return;
            }

            const fd = new FormData();
            mainPlayers.forEach(p => fd.append('mainPlayerIds', p.dataset.playerId));
            subPlayers.forEach(p => fd.append('subPlayerIds', p.dataset.playerId));

            Swal.fire({
                title: 'Đang lưu đội hình...',
                html: 'Vui lòng chờ trong giây lát.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const headers = {};
                if (csrfToken && csrfHeaderName) headers[csrfHeaderName] = csrfToken;

                const response = await fetch(formEl.getAttribute('action'), {
                    method: formEl.getAttribute('method') || 'post',
                    body: fd,
                    headers: headers
                });



                let body = null;
                const text = await response.text();
                try { body = text ? JSON.parse(text) : null; } catch (e) { body = null; }

                if (response.ok) {
                    const message = (body && (body.message || body.successMessage)) ? (body.message || body.successMessage) : 'Lưu đội hình thành công.';
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công',
                        text: message,
                        confirmButtonText: 'Về lịch thi đấu'
                    }).then((result) => {
                        if (redirectAfterSave) {
                            window.location.href = redirectAfterSave;
                        } else {
                            window.location.reload();
                        }
                    });
                } else {
                    const errMsg = (body && (body.error || body.message)) ? (body.error || body.message) : `Lỗi khi lưu (status ${response.status})`;
                    Swal.fire({ icon: 'error', title: 'Lưu thất bại', text: errMsg });
                }
            } catch (err) {
                console.error('Save error', err);
                Swal.fire({ icon: 'error', title: 'Lỗi kết nối', text: 'Không thể kết nối tới máy chủ. Vui lòng thử lại.' });
            }
        });

        // === 7. Logic nút Reset (MỚI) ===
        resetButton.addEventListener('click', () => {
            const filledCount = document.querySelectorAll('.player-slot.filled, .bench-slot.filled').length;
            if(filledCount === 0) {
                Swal.fire({ icon: 'info', title: 'Thông báo', text: 'Sân chưa có cầu thủ nào để xếp lại.'});
                return;
            }

            Swal.fire({
                title: 'Xếp lại từ đầu?',
                text: "Toàn bộ cầu thủ trên sân và dự bị sẽ quay về danh sách chờ.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Đồng ý, xếp lại!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    performReset();
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã làm mới',
                        timer: 1000,
                        showConfirmButton: false
                    });
                }
            });
        });

        function performReset() {
            const filledSlots = document.querySelectorAll('.player-slot.filled, .bench-slot.filled');
            filledSlots.forEach(slot => {
                const playerItem = slot.querySelector('.player-item');
                if (playerItem) {
                    const id = playerItem.dataset.playerId;
                    const name = playerItem.dataset.playerName;
                    const pos = playerItem.dataset.pos;
                    // Trả về pool
                    playerPool.appendChild(createPlayerElement(id, name, pos));
                }
                // Xóa slot
                clearSlot(slot);
            });
            updateAllCounts();
        }

        // === 8. Khởi tạo trạng thái từ dữ liệu ban đầu ===
        function loadInitialLineup() {
            initialMainPlayers.forEach(player => {
                const playerEl = document.querySelector(`#available-players .player-item[data-player-id="${player.id}"]`);
                if (playerEl) playerEl.remove();
                const emptySlot = document.querySelector('.player-slot:not(.filled)');
                if (emptySlot) {
                    const slotLabelEl = emptySlot.querySelector('.slot-label');
                    const slotLabel = slotLabelEl ? slotLabelEl.innerText : '';
                    emptySlot.innerHTML = '';
                    emptySlot.appendChild(createFilledSlotElement(player.id, player.name, player.position, slotLabel));
                    emptySlot.classList.add('filled');
                }
            });

            initialSubPlayers.forEach(player => {
                const playerEl = document.querySelector(`#available-players .player-item[data-player-id="${player.id}"]`);
                if (playerEl) playerEl.remove();
                const emptyBenchSlot = document.querySelector('.bench-slot:not(.filled)');
                if (emptyBenchSlot) {
                    emptyBenchSlot.innerHTML = '';
                    emptyBenchSlot.appendChild(createFilledBenchElement(player.id, player.name, player.position));
                    emptyBenchSlot.classList.add('filled');
                }
            });

            updateAllCounts();
        }

        // Observe DOM changes
        const observer = new MutationObserver(() => {
            document.querySelectorAll('.player-item').forEach(el => {
                if (!el.classList.contains('dragging') && !el.hasAttribute('data-listener')) {
                    addDragEventsToPlayer(el);
                    el.setAttribute('data-listener', '1');
                }
            });
            updateAllCounts();
        });
        observer.observe(playerPool, { childList: true, subtree: true });
        observer.observe(document.querySelector('.pitch-area'), { childList: true, subtree: true });
        observer.observe(document.querySelector('.bench-slots'), { childList: true, subtree: true });

        loadInitialLineup();
    });
</script>

</body>
</html>