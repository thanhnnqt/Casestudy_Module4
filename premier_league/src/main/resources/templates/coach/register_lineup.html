<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đăng ký đội hình thi đấu</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- Variables --- */
        :root{
            --pl-deep: #38003c;    /* tím than */
            --pl-neon: #00ff85;    /* xanh neon */
            --pl-pink: #ff0050;
            --card-bg: linear-gradient(180deg, rgba(56,0,60,0.92), rgba(56,0,60,0.85));
            --glass: rgba(255,255,255,0.04);
            --muted: #bfc6cc;
        }

        /* --- Reset / Base --- */
        html,body { height:100%; }
        body {
            font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: radial-gradient(1200px 400px at 10% 5%, rgba(56,0,60,0.06), transparent 8%),
            radial-gradient(900px 300px at 90% 95%, rgba(0,255,133,0.02), transparent 6%),
            #f4f6f8;
            color:#0b1220;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            padding-bottom:48px;
        }
        .container-fluid { max-width: 1400px; }

        /* --- Header area --- */
        .pl-page-header {
            background: var(--card-bg);
            color: white;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(56,0,60,0.18);
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:16px;
            margin-bottom:20px;
        }
        .pl-title {
            font-weight:900;
            letter-spacing:0.6px;
            font-size:1.6rem;
            display:flex;
            flex-direction:column;
            line-height:1;
        }
        .pl-sub {
            color: rgba(255,255,255,0.85);
            font-weight:600;
            font-size:0.95rem;
            margin-top:6px;
        }

        /* --- Card / panels --- */
        .card-custom {
            border-radius:12px;
            overflow:hidden; /* Giữ nguyên hidden ở cha để bo góc */
            background:linear-gradient(180deg, #ffffff, #fbfcfd);
            box-shadow: 0 6px 18px rgba(6,6,8,0.06);
            height: 85vh;
            display:flex;
            flex-direction:column; /* Quan trọng cho flex layout dọc */
        }
        .card-header-custom {
            padding:12px 16px;
            border-bottom:1px solid rgba(11,18,32,0.04);
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            background: linear-gradient(180deg, rgba(56,0,60,0.03), rgba(56,0,60,0.01));
            flex-shrink: 0; /* Không cho header bị co lại */
        }
        .card-header-custom .title {
            font-weight:700;
            color: var(--pl-deep);
        }

        /* --- [FIXED] Scrollable Content --- */
        .scrollable-content {
            flex: 1;            /* Chiếm toàn bộ chiều cao còn lại */
            overflow-y: auto;   /* Hiện thanh cuộn dọc khi cần thiết */
            overflow-x: hidden; /* Ẩn thanh cuộn ngang */
            padding: 10px;      /* Thêm padding để nội dung không sát lề */
            min-height: 0;      /* Fix lỗi flexbox trên một số trình duyệt cũ */
        }

        /* Tùy chỉnh thanh cuộn (Scrollbar) cho đẹp hơn */
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: rgba(56,0,60,0.2);
            border-radius: 20px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(56,0,60,0.4);
        }

        /* --- Player Row (pool) --- */
        .player-draggable {
            background: linear-gradient(90deg, #fff, #fbfbff);
            border: 1px solid rgba(56,0,60,0.06);
            border-left: 4px solid rgba(56,0,60,0.06);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: grab;
            display:flex;
            align-items:center;
            justify-content:space-between;
            transition: transform .14s ease, box-shadow .14s ease;
        }
        .player-draggable:hover {
            transform: translateX(6px);
            box-shadow: 0 6px 18px rgba(56,0,60,0.06);
            border-left-color: var(--pl-deep);
        }
        .player-draggable.dragging {
            opacity: 0.6;
            transform: scale(0.98);
            border-style: dashed;
        }

        .pos-badge {
            width:42px; height:42px;
            display:flex; align-items:center; justify-content:center;
            border-radius:10px; font-weight:700; color:white; font-size:0.78rem;
            margin-right:12px;
            box-shadow: inset 0 -6px 18px rgba(0,0,0,0.06);
        }
        .pos-GK { background: linear-gradient(180deg,#f6a83d,#d98a17); }
        .pos-DF { background: linear-gradient(180deg,#4bd07b,#1e8d4a); }
        .pos-MF { background: linear-gradient(180deg,#4f83ff,#0d52ff); }
        .pos-FW { background: linear-gradient(180deg,#ff6b7a,#d92b3a); }

        .player-draggable .meta {
            display:flex; gap:8px; align-items:center;
        }
        .player-draggable .name { font-weight:700; color:#0b1220; }
        .player-draggable .sub { color:var(--muted); font-size:0.82rem; }

        /* --- Drop zones --- */
        .drop-zone {
            /* Đã xóa min-height cứng ở đây vì flex layout sẽ lo việc đó,
               nhưng giữ border style cho đẹp */
            border: 2px dashed rgba(56,0,60,0.08);
            border-radius: 12px; /* Bo góc trong content */
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.9));
            transition: background .12s ease, border-color .12s ease, box-shadow .12s ease;
        }
        .drop-zone.drag-over {
            background: linear-gradient(180deg, rgba(0,255,133,0.04), rgba(56,0,60,0.02));
            border-color: rgba(0,255,133,0.4);
            box-shadow: 0 10px 28px rgba(0,255,133,0.03);
        }

        /* --- Squad / badges --- */
        .badge.pl-main { background:var(--pl-neon); color: #0b1220; font-weight:700; }
        .badge.pl-empty { background: rgba(56,0,60,0.06); color: var(--pl-deep); font-weight:600; }
        .badge.pl-warning { background: #fff6e0; color: #a66f00; font-weight:700; }

        /* --- Captain wrapper styling --- */
        .captain-wrapper {
            border-left: 2px solid rgba(56,0,60,0.06);
            padding-left:10px;
            margin-left:10px;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .captain-select { transform:scale(1.15); cursor:pointer; accent-color:var(--pl-neon); }

        /* --- Buttons (PL style) --- */
        .btn-pl-primary {
            background: linear-gradient(90deg,var(--pl-neon), #00e672);
            color: var(--pl-deep);
            border: none;
            font-weight:700;
            box-shadow: 0 8px 20px rgba(0,255,133,0.08);
            border-radius: 10px;
            padding: .56rem .9rem;
        }
        .btn-pl-primary:hover { transform: translateY(-2px); filter:brightness(.98); }

        .btn-pl-outline {
            background: rgba(255,255,255,0.08);      /* sáng hơn so với background header */
            border: 1px solid rgba(0,255,133,0.12);  /* viền neon mờ */
            color: var(--pl-neon);                    /* text xanh neon để nổi */
            font-weight:600;
            border-radius:10px;
            padding:.46rem .75rem;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12), 0 2px 6px rgba(0,255,133,0.03);
            backdrop-filter: blur(4px);               /* tạo hiệu ứng glass, giúp tương phản */
        }

        /* small responsive tweaks */
        @media (max-width:991px) {
            .card-custom { height: auto; min-height: 500px; }
            .player-draggable { padding: 8px; }
            .pos-badge { width:36px; height:36px; }
            /* Trên mobile thì giới hạn chiều cao danh sách để vẫn scroll được */
            .scrollable-content { height: 400px; flex: none; }
        }
    </style>
</head>
<body>

<div class="container-fluid py-4">

    <div class="pl-page-header">
        <div>
            <div class="pl-title">QUẢN LÝ ĐĂNG KÝ ĐỘI HÌNH</div>
            <div class="pl-sub">Trận: <span th:text="${match.homeTeam.name} + ' vs ' + ${match.awayTeam.name}">Team A vs Team B</span></div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <a th:href="@{/coach/team/{teamId}/schedule(teamId=${teamId})}" class="btn btn-pl-outline d-flex align-items-center gap-2">
                <i class="bi bi-arrow-left-circle"></i> Trở về Lịch
            </a>

            <button type="button" id="resetBtn" class="btn btn-pl-outline d-flex align-items-center gap-2" title="Đặt lại đội hình">
                <i class="bi bi-arrow-counterclockwise"></i> Đặt lại
            </button>

            <form id="submitForm" method="post" th:action="@{/coach/team/{teamId}/match/{matchId}/register/save(teamId=${teamId}, matchId=${match.id})}">
                <div id="hiddenInputs"></div>
                <input type="hidden" name="captainId" id="captainIdInput">
                <div style="display:inline-block">
                    <button type="button" id="confirmBtn" class="btn btn-pl-primary d-flex align-items-center gap-2">
                        <i class="bi bi-check-lg"></i> Xác nhận đăng ký
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div th:if="${error}" class="alert alert-danger mt-3 rounded shadow-sm" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}"></span>
    </div>

    <div class="row g-4 mt-2">

        <div class="col-lg-4">
            <div class="card-custom">
                <div class="card-header-custom">
                    <div class="d-flex align-items-center gap-3">
                        <i class="bi bi-people-fill fs-4" style="color:var(--pl-deep)"></i>
                        <div>
                            <div class="title">Danh sách cầu thủ</div>
                            <div class="small text-muted">Kéo cầu thủ vào đội hình chính hoặc dự bị</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span id="poolCount" class="badge pl-empty">0</span>
                    </div>
                </div>

                <div class="p-2 border-bottom" style="background:transparent;">
                    <input type="text" class="form-control form-control-sm" id="searchPlayer" placeholder="Tìm kiếm tên cầu thủ...">
                </div>

                <div class="scrollable-content drop-zone" id="playerPool" aria-label="Player pool">
                    <div th:each="p : ${allPlayersForTable}"
                         class="player-draggable"
                         draggable="true"
                         th:data-id="${p.id}"
                         th:data-name="${p.name}"
                         th:data-pos="${p.position}">

                        <div class="d-flex align-items-center">
                            <div class="pos-badge" th:classappend="'pos-' + ${p.position}" th:text="${p.position}">DF</div>
                            <div>
                                <div class="name fw-bold" th:text="${p.name}">Nguyen Van A</div>
                                <div class="sub small" th:text="${p.age} + ' tuổi · Exp: ' + ${p.experience}">22 tuổi · Exp: 3</div>
                            </div>
                        </div>

                        <div class="text-end d-flex align-items-center">
                            <div th:if="${p.yellowCards > 0}" class="me-2" title="Thẻ vàng">
                                <i class="bi bi-square-fill" style="color: #ffc107"></i> <small class="text-muted" th:text="${p.yellowCards}">1</small>
                            </div>
                            <div th:if="${p.redCards > 0}" class="me-2" title="Thẻ đỏ">
                                <i class="bi bi-square-fill" style="color: #dc3545"></i> <small class="text-muted" th:text="${p.redCards}">0</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-custom border" style="border-color: rgba(56,0,60,0.06);">
                <div class="card-header-custom" style="background: linear-gradient(90deg, rgba(56,0,60,0.03), rgba(0,255,133,0.02));">
                    <div class="d-flex align-items-center gap-3">
                        <i class="bi bi-shield-fill-check fs-4" style="color:var(--pl-neon)"></i>
                        <div>
                            <div class="title">Đá chính (11)</div>
                            <div class="small text-muted">Kéo cầu thủ vào đây. Chọn 1 đội trưởng (©).</div>
                        </div>
                    </div>
                    <div>
                        <span id="mainCount" class="badge pl-main">0/11</span>
                    </div>
                </div>

                <div class="p-2 bg-light small text-center text-muted fst-italic">
                    Sắp xếp đội hình → Kéo thả hoặc chạm để di chuyển
                </div>

                <div class="scrollable-content drop-zone" id="mainSquad" aria-label="Main squad"></div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-custom border" style="border-color: rgba(255,197,0,0.06);">
                <div class="card-header-custom" style="background: linear-gradient(90deg, rgba(255,197,0,0.03), rgba(56,0,60,0.01));">
                    <div class="d-flex align-items-center gap-3">
                        <i class="bi bi-person-plus-fill fs-4" style="color:#f0ad4e"></i>
                        <div>
                            <div class="title">Dự bị (Max 9)</div>
                            <div class="small text-muted">Kéo cầu thủ vào ghế dự bị</div>
                        </div>
                    </div>
                    <div>
                        <span id="subCount" class="badge pl-warning">0/9</span>
                    </div>
                </div>

                <div class="scrollable-content drop-zone" id="subSquad" aria-label="Sub squad"></div>
            </div>
        </div>

    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const savedMainIds = /*[[${mainPlayers != null ? mainPlayers.![id] : {}}]]*/ [];
    const savedSubIds = /*[[${subPlayers != null ? subPlayers.![id] : {}}]]*/ [];
    const savedCaptainId = /*[[${currentCaptainId}]]*/ null;
    /*]]>*/
</script>

<script>
    // Toast helper (SweetAlert2)
    function showToast(type, message, position = 'top-end', timer = 2000) {
        Swal.fire({
            toast: true,
            position: position,
            icon: type,
            title: message,
            showConfirmButton: false,
            timer: timer,
            timerProgressBar: true,
            customClass: { popup: 'rounded-xl' }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const pool = document.getElementById('playerPool');
        const main = document.getElementById('mainSquad');
        const sub = document.getElementById('subSquad');
        const confirmBtn = document.getElementById('confirmBtn');
        const resetBtn = document.getElementById('resetBtn');

        // position order for sorting
        const posOrder = { 'GK': 0, 'DF': 1, 'MF': 2, 'FW': 3 };

        // Initialize draggables after DOM content (some elements generated by Thymeleaf)
        function initDraggables() {
            document.querySelectorAll('.player-draggable').forEach(draggable => {
                // avoid double-binding
                if (!draggable.dataset.listener) {
                    draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
                    draggable.addEventListener('dragend', () => {
                        draggable.classList.remove('dragging');
                        updateUI();
                    });
                    draggable.dataset.listener = '1';
                }
            });
        }

        // Sort player pool by position then name
        function sortPlayerPool() {
            const items = Array.from(pool.querySelectorAll('.player-draggable'));
            items.sort((a,b) => {
                const pa = (a.dataset.pos || '').toUpperCase();
                const pb = (b.dataset.pos || '').toUpperCase();
                const oa = posOrder.hasOwnProperty(pa) ? posOrder[pa] : 99;
                const ob = posOrder.hasOwnProperty(pb) ? posOrder[pb] : 99;
                if (oa !== ob) return oa - ob;
                const na = (a.dataset.name || '').toLowerCase();
                const nb = (b.dataset.name || '').toLowerCase();
                return na.localeCompare(nb);
            });
            // re-append in order
            items.forEach(it => pool.appendChild(it));
            updateUI();
        }

        // restore saved state
        function restoreState() {
            // Move saved main players
            if(savedMainIds && savedMainIds.length > 0) {
                savedMainIds.forEach(id => {
                    const el = pool.querySelector(`.player-draggable[data-id="${id}"]`);
                    if (el) { main.appendChild(el); addCaptainRadio(el); }
                });
            }
            // Move saved sub players
            if(savedSubIds && savedSubIds.length > 0) {
                savedSubIds.forEach(id => {
                    const el = pool.querySelector(`.player-draggable[data-id="${id}"]`);
                    if (el) sub.appendChild(el);
                });
            }
            // After moving, ensure draggables attached and pool sorted
            initDraggables();
            sortPlayerPool();
        }

        initDraggables();
        restoreState(); // move saved players to main/sub if any

        // Drop zones
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const draggable = document.querySelector('.dragging');
                if (!draggable) return;

                // Validate limits
                if (zone.id === 'mainSquad' && main.children.length >= 11 && !main.contains(draggable)) {
                    showToast('warning', 'Đội hình chính chỉ được tối đa 11 người!');
                    return;
                }
                if (zone.id === 'subSquad' && sub.children.length >= 9 && !sub.contains(draggable)) {
                    showToast('warning', 'Danh sách dự bị chỉ được tối đa 9 người!');
                    return;
                }

                zone.appendChild(draggable);

                // Xử lý Captain radio
                if (zone.id === 'mainSquad') {
                    addCaptainRadio(draggable);
                } else {
                    // Nếu kéo ra khỏi Main, xóa nút Captain
                    const radioWrapper = draggable.querySelector('.captain-wrapper');
                    if (radioWrapper) radioWrapper.remove();
                    // remove any checked radio too
                    const radio = draggable.querySelector('input[name="captainGroup"]');
                    if (radio) radio.checked = false;
                }

                // If dropped into pool, sort pool so the moved player lands in correct place
                if (zone.id === 'playerPool') {
                    // ensure draggable has data-pos and data-name (if not, try to set from inner text)
                    if (!draggable.dataset.pos) {
                        const badge = draggable.querySelector('.pos-badge');
                        if (badge) draggable.dataset.pos = badge.textContent.trim();
                    }
                    if (!draggable.dataset.name) {
                        const nameNode = draggable.querySelector('.fw-bold');
                        if (nameNode) draggable.dataset.name = nameNode.textContent.trim();
                    }
                    sortPlayerPool();
                }

                updateUI();
            });
        });

        // Search
        document.getElementById('searchPlayer').addEventListener('keyup', function() {
            const val = this.value.toLowerCase();
            pool.querySelectorAll('.player-draggable').forEach(item => {
                const name = (item.getAttribute('data-name') || '').toLowerCase();
                item.style.display = name.includes(val) ? 'flex' : 'none';
            });
        });

        // Confirm button
        confirmBtn.addEventListener('click', () => {
            validateAndSubmit();
        });

        // Reset button: confirm then performReset
        resetBtn.addEventListener('click', () => {
            const totalFilled = document.querySelectorAll('#mainSquad .player-draggable, #subSquad .player-draggable').length;
            if (totalFilled === 0) {
                Swal.fire({ icon: 'info', title: 'Thông báo', text: 'Không có cầu thủ trên sân để đặt lại.'});
                return;
            }

            Swal.fire({
                title: 'Đặt lại đội hình?',
                text: 'Toàn bộ cầu thủ ở đội hình chính và dự bị sẽ trở về bảng chờ.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
                reverseButtons: true,
                customClass: { popup: 'rounded-xl' }
            }).then((res) => {
                if (res.isConfirmed) {
                    performReset();
                    showToast('success', 'Đã đặt lại đội hình', 'top-end', 1500);
                }
            });
        });

        // Re-init when using restoreState or dynamic changes (re-attach listeners)
        const observer = new MutationObserver(() => {
            initDraggables();
            updateUI();
        });
        observer.observe(pool, { childList: true, subtree: true });
        observer.observe(main, { childList: true, subtree: true });
        observer.observe(sub, { childList: true, subtree: true });

        updateUI();

        // --- functions used above ---

        function addCaptainRadio(playerEl) {
            if (playerEl.querySelector('.captain-wrapper')) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'captain-wrapper ms-3 border-start ps-3 d-flex align-items-center';

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'captainGroup';
            radio.className = 'form-check-input captain-select';
            radio.value = playerEl.getAttribute('data-id');

            if (savedCaptainId && radio.value == savedCaptainId) radio.checked = true;

            const label = document.createElement('label');
            label.className = 'd-block small fw-bold text-warning ms-2 mb-0';
            label.innerText = '©';

            wrapper.appendChild(radio);
            wrapper.appendChild(label);
            playerEl.appendChild(wrapper);
        }

        function updateUI() {
            const mainCount = document.getElementById('mainSquad').children.length;
            document.getElementById('mainCount').innerText = `${mainCount}/11`;
            document.getElementById('subCount').innerText = `${document.getElementById('subSquad').children.length}/9`;
            document.getElementById('poolCount').innerText = document.querySelectorAll('#playerPool .player-draggable').length;

            const badge = document.getElementById('mainCount');
            badge.className = mainCount === 11 ? 'badge pl-main' : 'badge pl-empty';
        }

        function validateAndSubmit() {
            const mainDivs = document.querySelectorAll('#mainSquad .player-draggable');
            const subDivs = document.querySelectorAll('#subSquad .player-draggable');

            // 1. Check main count
            if (mainDivs.length !== 11) {
                Swal.fire({
                    icon: 'error',
                    title: 'Số lượng đội hình không hợp lệ',
                    html: `Bạn mới chọn <strong>${mainDivs.length}</strong> cầu thủ đá chính. Cần đủ <strong>11</strong> người.`,
                    customClass: { popup: 'rounded-xl' }
                });
                return;
            }

            // 2. Check sub count
            if (subDivs.length < 1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu dự bị',
                    text: 'Phải chọn tối thiểu 1 cầu thủ dự bị!',
                    customClass: { popup: 'rounded-xl' }
                });
                return;
            }

            // 3. Check captain
            const captainRadio = document.querySelector('input[name="captainGroup"]:checked');
            if (!captainRadio) {
                Swal.fire({
                    icon: 'error',
                    title: 'Chưa chọn đội trưởng',
                    text: 'Vui lòng chọn Đội trưởng (©) trong danh sách đá chính!',
                    customClass: { popup: 'rounded-xl' }
                });
                return;
            }

            // 4. Confirmation modal before submit
            Swal.fire({
                title: 'Xác nhận đăng ký đội hình',
                html: `<div>Bạn xác nhận đăng ký đội hình này cho trận đấu?</div>
                       <div class="mt-2 text-muted small">Số cầu thủ chính: <strong>${mainDivs.length}</strong> - Dự bị: <strong>${subDivs.length}</strong></div>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                reverseButtons: true,
                customClass: { popup: 'rounded-xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    // prepare hidden inputs
                    const container = document.getElementById('hiddenInputs');
                    container.innerHTML = '';

                    mainDivs.forEach(el => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'mainPlayerIds';
                        input.value = el.dataset.id;
                        container.appendChild(input);
                    });

                    subDivs.forEach(el => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'subPlayerIds';
                        input.value = el.dataset.id;
                        container.appendChild(input);
                    });

                    document.getElementById('captainIdInput').value = captainRadio.value;

                    // Optional: show a short saving toast then submit
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Đang gửi đăng ký...',
                        showConfirmButton: false,
                        timer: 900,
                        timerProgressBar: true,
                        customClass: { popup: 'rounded-xl' }
                    });

                    // submit the form
                    document.getElementById('submitForm').submit();
                }
            });
        }

        // Perform reset: move all from main & sub back to pool and remove captain wrappers
        function performReset() {
            const moved = [];

            // Move main squad players back
            document.querySelectorAll('#mainSquad .player-draggable').forEach(p => {
                // remove captain wrapper if any
                const cap = p.querySelector('.captain-wrapper');
                if (cap) cap.remove();
                // ensure data attributes exist: data-name/data-pos
                ensureDataAttributesFromDom(p);
                pool.appendChild(p);
                moved.push(p);
            });

            // Move sub squad players back
            document.querySelectorAll('#subSquad .player-draggable').forEach(p => {
                const cap = p.querySelector('.captain-wrapper');
                if (cap) cap.remove();
                ensureDataAttributesFromDom(p);
                pool.appendChild(p);
                moved.push(p);
            });

            // re-attach drag events & sort pool & update counts
            initDraggables();
            sortPlayerPool();
            updateUI();
        }

        function ensureDataAttributesFromDom(el) {
            if (!el.dataset.name) {
                const nameEl = el.querySelector('.fw-bold') || el.querySelector('.name') || el;
                el.dataset.name = (nameEl && nameEl.textContent) ? nameEl.textContent.trim() : 'Unknown';
            }
            if (!el.dataset.pos) {
                const posEl = el.querySelector('.pos-badge') || el.querySelector('.position');
                el.dataset.pos = (posEl && posEl.textContent) ? posEl.textContent.trim() : '';
            }
        }
    });
</script>

</body>
</html>