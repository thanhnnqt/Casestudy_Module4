<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout('Cập nhật nhân viên', 'staffs', ~{::content})">

<th:block th:fragment="content">

    <style>
        :root { --pl-purple: #38003c; --pl-pink: #ff0050; }
        .card-form { border: none; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: #fff; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #4b5563; }
        .form-control, .form-select { border-radius: 0.5rem; padding: 0.6rem 1rem; border: 1px solid #e5e7eb; }
        .form-control:focus, .form-select:focus { border-color: var(--pl-pink); box-shadow: 0 0 0 4px rgba(255, 0, 80, 0.1); }
        .btn-save { background-color: var(--pl-purple); border: none; color: white; padding: 0.75rem 2rem; font-weight: 600; border-radius: 0.5rem; }
        .btn-save:hover { background-color: #2a002d; transform: translateY(-2px); }
        .section-title { color: var(--pl-purple); font-weight: 700; text-transform: uppercase; font-size: 0.85rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 10px; margin-bottom: 20px; }
    </style>

    <div class="container-fluid" style="max-width: 1000px;">
        <div class="mb-4">
            <h3 class="fw-bold" style="color: var(--pl-purple);">Cập nhật thông tin</h3>
        </div>

        <form th:object="${staffDto}"
              th:action="@{'/admin/staffs/update'}"
              method="post">

            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{teamId}">

            <input type="hidden" id="currentRoleValue" th:value="*{role}">

            <div class="card card-form p-4 mb-4">
                <div class="section-title">1. Thông tin cá nhân</div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" th:field="*{fullName}">
                        <small class="text-danger" th:errors="*{fullName}"></small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Ngày sinh</label>
                        <input type="date" class="form-control" th:field="*{dateOfBirth}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Giới tính</label>
                        <select class="form-select" th:field="*{gender}">
                            <option value="Male">Nam</option>
                            <option value="Female">Nữ</option>
                            <option value="Other">Khác</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" th:field="*{phoneNumber}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" th:field="*{email}">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Quốc tịch</label>
                        <input type="text" class="form-control" th:field="*{nationality}">
                    </div>
                </div>
            </div>

            <div class="card card-form p-4 mb-4">
                <div class="section-title">2. Thông tin công việc</div>
                <div class="row g-4">

                    <div class="col-md-6">
                        <label class="form-label">Vị trí công tác</label>
                        <select class="form-select" id="positionSelect" th:field="*{position}">
                            <option value="">-- Chọn vị trí --</option>
                            <option value="Medical">Bộ phận Y tế</option>
                            <option value="Technical">Kỹ thuật & Phân tích</option>
                            <option value="Operations">Vận hành & Hậu cần</option>
                            <option value="Media">Truyền thông & Marketing</option>
                            <option value="Management">Quản lý & Văn phòng</option>
                        </select>
                        <small class="text-danger" th:errors="*{position}"></small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Vai trò cụ thể</label>
                        <select class="form-select" id="roleSelect" th:field="*{role}">
                            <option value="">-- Vui lòng chọn vị trí trước --</option>
                        </select>
                        <small class="text-danger" th:errors="*{role}"></small>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ngày gia nhập</label>
                        <input type="date" class="form-control" th:field="*{joinDate}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" th:field="*{status}">
                            <option value="Active">Đang làm việc</option>
                            <option value="Inactive">Nghỉ</option>
                            <option value="On Loan">Cho mượn</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Link ảnh đại diện</label>
                        <input type="text" class="form-control" th:field="*{avatarUrl}">
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 pb-5">
                <a href="/admin/staffs" class="btn btn-light px-4 fw-bold text-muted border">Hủy bỏ</a>
                <button type="submit" class="btn btn-save"><i class="bi bi-check2-circle me-2"></i>Cập nhật</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {

            // 1. Dữ liệu
            const rolesData = {
                "Medical": ["Head Doctor (Bác sĩ trưởng)", "Physiotherapist (Vật lý trị liệu)", "Masseur (Massage)", "Nutritionist (Dinh dưỡng)", "Psychologist (Tâm lý)"],
                "Technical": ["Data Analyst (Phân tích dữ liệu)", "Scout (Tuyển trạch viên)", "Performance Analyst (Phân tích hiệu suất)", "Sport Scientist (Khoa học thể thao)"],
                "Operations": ["Kit Manager (Quản lý trang phục)", "Groundskeeper (Chăm sóc sân cỏ)", "Bus Driver (Tài xế)", "Security Officer (An ninh)", "Chef (Đầu bếp)"],
                "Media": ["Social Media Manager (Quản lý MXH)", "Photographer (Nhiếp ảnh gia)", "Videographer (Quay phim)", "Press Officer (Cán bộ báo chí)"],
                "Management": ["HR Manager (Nhân sự)", "Finance Officer (Tài chính)", "Administrator (Hành chính)"]
            };

            const positionSelect = document.getElementById('positionSelect');
            const roleSelect = document.getElementById('roleSelect');
            const currentRoleValue = document.getElementById('currentRoleValue').value; // Lấy vai trò cũ

            // 2. Hàm update (Có thêm tham số selectedRole để chọn lại vai trò cũ)
            function updateRoles(selectedPos, selectedRole = null) {
                roleSelect.innerHTML = '<option value="">-- Chọn vai trò --</option>';

                if (selectedPos && rolesData[selectedPos]) {
                    rolesData[selectedPos].forEach(function(roleName) {
                        const option = document.createElement('option');
                        option.value = roleName;
                        option.text = roleName;

                        // Nếu role này trùng với role cũ -> Đánh dấu selected
                        if (selectedRole && roleName === selectedRole) {
                            option.selected = true;
                        }

                        roleSelect.appendChild(option);
                    });
                }
            }

            // 3. Sự kiện Change (Khi người dùng đổi vị trí)
            positionSelect.addEventListener('change', function() {
                updateRoles(this.value); // Không truyền selectedRole để nó reset
            });

            // 4. KHI TRANG VỪA LOAD (QUAN TRỌNG CHO TRANG UPDATE)
            const initialPos = positionSelect.value;
            if (initialPos) {
                updateRoles(initialPos, currentRoleValue);
            }
        });
    </script>

</th:block>
</html>