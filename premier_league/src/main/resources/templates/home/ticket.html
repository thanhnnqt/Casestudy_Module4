<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đặt vé - V.League</title>

    <!-- 1. CSS Variables -->
    <link rel="stylesheet" th:href="@{/css/application.css}"/>

    <!-- 2. Tailwind CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                    }
                }
            }
        }
    </script>

    <!-- 3. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 4. CSS cho Toast Notification (thay thế useToast) -->
    <style>
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            z-index: 100;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            visibility: hidden;
        }

        #toast-notification.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .toast-success {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .toast-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }
    </style>
    <link rel="stylesheet" th:href="@{/css/home-css.css}"/>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- Header Fragment -->
<div th:replace="~{layout/navbar.html :: header}"></div>

<!-- Main Content -->
<div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Đặt vé xem trận đấu</h1>
            <p class="text-gray-600">Chọn trận đấu và số lượng vé bạn muốn đặt</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3">

            <!-- 1. Match Selection (Danh sách trận đấu) -->
            <div class="lg:col-span-3 space-y-4">
                <h2 class="text-2xl font-bold mb-4">Chọn trận đấu</h2>

                <!-- Loop qua các trận đấu (Controller phải cung cấp: upcomingMatches) -->
                <div th:each="match : ${upcomingMatches}"
                     th:id="${match.id}"
                     onclick="selectMatch(this)"
                     class="match-card bg-white rounded-lg p-6 cursor-pointer transition-all border-2 border-transparent hover:border-gray-300">

                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            <span th:text="${#dates.format(match.date, 'dd/MM/yyyy')} + ' - ' + ${match.time}">01/01/2024 - 19:00</span>
                        </div>
                        <span th:if="${match.isImportant}"
                              class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
                                QUAN TRỌNG
                            </span>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-lg font-semibold flex-1 text-right" th:text="${match.homeTeam}">Home</div>
                        <div class="text-2xl font-bold text-primary mx-8">VS</div>
                        <div class="text-lg font-semibold flex-1" th:text="${match.awayTeam}">Away</div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1 text-sm text-gray-600">
                            <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                            <span th:text="${match.stadium}">Stadium</span>
                        </div>
                        <div class="text-primary font-bold">300.000đ - 1.000.000đ</div>
                    </div>
                </div>

                <div th:each=" matchSchedule: ${matchSchedulePage.content}">

                </div>

                <div th:if="${#lists.isEmpty(matchSchedulePage)}" class="text-center text-gray-500 py-10">
                    <p>Không có trận đấu nào sắp diễn ra.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div th:each="match : ${matchSchedulePage.content}"
                         class="relative bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden group hover:border-primary/30 transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-primary/5 to-transparent rounded-bl-full"></div>

                        <div class="p-8">
                            <div class="flex justify-between items-center mb-6">
                                <span class="px-3 py-1 bg-red-50 text-red-600 text-xs font-bold rounded-full border border-red-100">BIG MATCH</span>
                                <div class="flex items-center gap-2 text-gray-500 text-sm font-medium">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    <span th:text="${#temporals.format(match.matchDate, 'dd/MM')}"></span>

                                    <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                    <span th:text="${match.matchTime}"></span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <!-- Home Team -->
                                <div class="text-center w-1/3">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center overflow-hidden">
                                        <img th:src="${match.homeTeam.logoUrl}" th:alt="${match.homeTeam.name}"
                                             class="w-full h-full object-cover"/>
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-900 truncate"
                                        th:text="${match.homeTeam.name}">
                                        Home</h3>
                                </div>

                                <!-- Divider -->
                                <div class="w-1/3 text-center">
                                    <div class="text-3xl font-black text-primary">VS</div>
                                    <p class="text-xs text-gray-400 mt-2" th:text="${match.homeTeam.stadium}">
                                        Stadium</p>
                                </div>

                                <!-- Away Team -->
                                <div class="text-center w-1/3">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center overflow-hidden">
                                        <img th:src="${match.awayTeam.logoUrl}" th:alt="${match.awayTeam.name}"
                                             class="w-full h-full object-cover"/>
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-900 truncate"
                                        th:text="${match.awayTeam.name}">
                                        Away</h3>
                                </div>
                            </div>


                        </div>
                        <div class="bg-gray-50 p-4 border-t border-gray-100 flex justify-center group-hover:bg-primary group-hover:text-white transition-colors cursor-pointer">
                            <a th:href="@{/tickets/create(id=${match.getId()})}"
                               class="font-bold text-sm flex items-center gap-2">ĐẶT VÉ NGAY <i data-lucide="ticket"
                                                                                                class="w-4 h-4"></i></a>
                        </div>
                    </div>
                </div>
                <!-- PAGINATION -->
                <div class="mt-8 flex justify-center" th:if="${totalPages > 1}">
                    <nav class="inline-flex items-center space-x-1" aria-label="Pagination">

                        <!-- Về trang đầu -->
                        <a th:href="@{/ticket(page=0)}"
                           th:classappend="${currentPage == 0} ? ' pointer-events-none opacity-40' : ''"
                           class="px-3 py-1 bg-white border border-gray-300 rounded-l-md text-sm text-gray-700 hover:bg-gray-50">
                            «
                        </a>

                        <!-- Trang trước -->
                        <a th:href="@{/ticket(page=${currentPage - 1})}"
                           th:classappend="${currentPage == 0} ? ' pointer-events-none opacity-40' : ''"
                           class="px-3 py-1 bg-white border border-gray-300 text-sm text-gray-700 hover:bg-gray-50">
                            ‹
                        </a>

                        <!-- Dấu ... trước -->
                        <span th:if="${startPage > 0}"
                              class="px-3 py-1 bg-white border border-gray-300 text-sm text-gray-500">
            ...
        </span>

                        <!-- Các số trang -->
                        <a th:each="i : ${#numbers.sequence(startPage, endPage)}"
                           th:text="${i + 1}"
                           th:href="@{/ticket(page=${i})}"
                           th:classappend="${i == currentPage} ? ' bg-primary text-white border-primary' : ' bg-white text-gray-700 hover:bg-gray-50'"
                           class="px-3 py-1 border border-gray-300 text-sm rounded-md mx-0.5">
                        </a>

                        <!-- Dấu ... sau -->
                        <span th:if="${endPage < totalPages - 1}"
                              class="px-3 py-1 bg-white border border-gray-300 text-sm text-gray-500">
            ...
        </span>

                        <!-- Trang sau -->
                        <a th:href="@{/ticket(page=${currentPage + 1})}"
                           th:classappend="${currentPage + 1 >= totalPages} ? ' pointer-events-none opacity-40' : ''"
                           class="px-3 py-1 bg-white border border-gray-300 text-sm text-gray-700 hover:bg-gray-50">
                            ›
                        </a>

                        <!-- Trang cuối -->
                        <a th:href="@{/ticket(page=${totalPages - 1})}"
                           th:classappend="${currentPage + 1 >= totalPages} ? ' pointer-events-none opacity-40' : ''"
                           class="px-3 py-1 bg-white border border-gray-300 rounded-r-md text-sm text-gray-700 hover:bg-gray-50">
                            »
                        </a>

                    </nav>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Footer Fragment -->
<div th:replace="~{layout/footer :: footer}"></div>

<!-- Toast Notification HTML -->
<div id="toast-notification">
    <h3 id="toast-title" class="font-bold"></h3>
    <p id="toast-description"></p>
</div>

<!-- Logic JavaScript -->
<script>
    // Khởi tạo icons
    lucide.createIcons();

    // Biến toàn cục (Global variable) để lưu trạng thái
    let selectedMatchId = null;
    let selectedTicketPrice = 300000;
    let selectedTicketCount = 1;

    // Hàm 1: Chọn trận đấu
    function selectMatch(element) {
        // Lấy ID từ element
        selectedMatchId = element.id;

        // Xóa style 'active' khỏi tất cả các thẻ
        const allMatchCards = document.querySelectorAll('.match-card');
        allMatchCards.forEach(card => {
            card.classList.remove('border-2', 'border-primary', 'shadow-lg');
            card.classList.add('border-2', 'border-transparent');
        });

        // Thêm style 'active' cho thẻ được click
        element.classList.add('border-2', 'border-primary', 'shadow-lg');
        element.classList.remove('border-transparent');

        // Ẩn placeholder, hiện form đặt vé
        document.getElementById('booking-placeholder').classList.add('hidden');
        document.getElementById('booking-form').classList.remove('hidden');

        // Cập nhật lại tóm tắt
        updateSummary();
    }

    // Hàm 2: Cập nhật tóm tắt
    function updateSummary() {
        const countInput = document.getElementById('ticket-count');
        const typeSelect = document.getElementById('ticket-type');

        selectedTicketCount = parseInt(countInput.value) || 1;
        selectedTicketPrice = parseInt(typeSelect.value) || 300000;

        const total = selectedTicketCount * selectedTicketPrice;

        // Cập nhật (Update) UI
        document.getElementById('summary-count').innerText = selectedTicketCount + ' vé';
        document.getElementById('summary-price').innerText = selectedTicketPrice.toLocaleString('vi-VN') + 'đ';
        document.getElementById('summary-total').innerText = total.toLocaleString('vi-VN') + 'đ';
    }

    // Hàm 3: Xử lý đặt vé
    function handleBooking() {
        if (!selectedMatchId) {
            showToast("Vui lòng chọn trận đấu", "Bạn cần chọn một trận đấu để đặt vé", "destructive");
            return;
        }

        // Gửi thông báo thành công
        const desc = `Bạn đã đặt ${selectedTicketCount} vé (${(selectedTicketCount * selectedTicketPrice).toLocaleString('vi-VN')}đ). Vui lòng kiểm tra email.`;
        showToast("Đặt vé thành công!", desc, "success");

        // Reset lại form
        resetBookingForm();
    }

    // Hàm 4: Reset form
    function resetBookingForm() {
        selectedMatchId = null;

        // Xóa style active
        const allMatchCards = document.querySelectorAll('.match-card');
        allMatchCards.forEach(card => {
            card.classList.remove('border-2', 'border-primary', 'shadow-lg');
            card.classList.add('border-2', 'border-transparent');
        });

        // Reset input
        document.getElementById('ticket-count').value = 1;
        document.getElementById('ticket-type').value = 300000;

        // Cập nhật lại summary (dù nó sẽ bị ẩn)
        updateSummary();

        // Ẩn form, hiện placeholder
        document.getElementById('booking-placeholder').classList.remove('hidden');
        document.getElementById('booking-form').classList.add('hidden');
    }

    // Hàm 5: Hiển thị Toast (Mô phỏng useToast)
    function showToast(title, description, variant = 'success') {
        const toast = document.getElementById('toast-notification');
        const toastTitle = document.getElementById('toast-title');
        const toastDesc = document.getElementById('toast-description');

        // Set nội dung
        toastTitle.innerText = title;
        toastDesc.innerText = description;

        // Set màu sắc
        toast.className = 'show'; // Bỏ các class màu cũ
        if (variant === 'destructive') {
            toast.classList.add('toast-destructive');
        } else {
            toast.classList.add('toast-success');
        }

        // Hiển thị
        toast.classList.add('show');

        // Tự động ẩn sau 5 giây
        setTimeout(() => {
            toast.classList.remove('show');
        }, 5000);
    }
</script>

</body>
</html>